OBJECT: 
 STRING TABLO,
 STRING MAILTEXT,
 STRING SORG,
 STRING TOO,
 STRING CCC,
 STRING SUBJ,
 DECIMAL TP,
 DECIMAL TP2,
 DECIMAL TPEUR,
 DECIMAL TPTL,
 DECIMAL TPUSD,
 DECIMAL TPGBP,
 DECIMAL TPUNKNOWN,
 DECIMAL TPEUR2,
 DECIMAL TPTL2,
 DECIMAL TPUSD2,
 DECIMAL TPGBP2,
 DECIMAL TPUNKNOWN2,
 INTEGER SAY,
 STRING PICT,
 STRING PICT2,
 STRING PICT3,
 STRING PICT4,
 STRING PICT5,
 STRING PICT6,
 STRING PICT7,
 STRING PICT8,
 STRING PICT9,
 STRING PICT10;

TP = 0;
TP2 = 0;
SAY = 0;

PICT = '-FL###,###,###.##';
PICT2 = '-FL###,###,###.##';
PICT3 = '-FL###,###,###.##';
PICT4 = '-FL###,###,###.##';
PICT5 = '-FL###,###,###.##';
PICT6 = '-FL###,###,###.##';
PICT7 = '-FL###,###,###.##';
PICT8 = '-FL###,###,###.##';
PICT9 = '-FL###,###,###.##';
PICT10 = '-FL###,###,###.##';

TPEUR = 0;
TPTL = 0;
TPUSD = 0;
TPGBP = 0;
TPUNKNOWN = 0;

TPEUR2 = 0;
TPTL2 = 0;
TPUSD2 = 0;
TPGBP2 = 0;
TPUNKNOWN2 = 0;

CLEARTABLE TMPTABLE;

TOO = ''; //İLGİLİ MAIL ADRESLERİ
CCC = ''; //İLGİLİ MAIL ADRESLERİ

SUBJ = 'BAST101 GELEN POSTALARDA, YENİDEKİ / HATALIDAKİ FATURALAR';

SELECT CASE DOCCHAR WHEN 3 THEN 'SATIŞ İADE' WHEN 0 THEN 'SATIŞ' WHEN 6 THEN 'ALIŞ ONAY' WHEN 4 THEN 'ALIŞ' ELSE '' END KAYITTIP, 
	 REFDOCTYPE AS BELTIP, REFDOCNUM AS BELNUM, LEFT(NAME1,
	 12) AS ISIM1, CAST(DOCDATE AS DATE) AS BELTARIH, DOCGRANDTOTAL AS BELTOPLAM, DOCCURRENCY AS BELPARABIRIM,
	 CAST(CREATEDAT AS DATE) AS OLUSTURMATARIH, CREATEDBY AS OLUSTURAN, DATEDIFF(DAY, CREATEDAT,
	 SYS_CURRENTDATE) AS KACGUNGECTI
	FROM IASEDIEINVOMSGQ 
	WHERE CLIENT = SYS_CLIENT
		AND COMPANY = '01' 
		AND POSTWAY = 0 
		AND ACCOUNTNAME = '01' 
		AND STATUS = 0 
		AND CREATEDAT <= SYS_CURRENTDATE 
		AND (DOCCHAR = 4 
		OR DOCCHAR = 1 
		OR DOCCHAR = 2 
		OR DOCCHAR = 3 
		OR DOCCHAR = 10 
		OR DOCCHAR = 11) 
		AND DOCDATE <= SYS_CURRENTDATE 
		AND ISEARCHIVE = 0 
		AND EDELTYPE = 0 
	INTO TMPTABLE;

TABLO = '<!DOCTYPE html> <html> <body>';

IF TMPTABLE_ROWCOUNT > 0 THEN

	LOOP AT TMPTABLE 
	BEGIN
		TP = TP + TMPTABLE_BELTOPLAM;
		
		IF TMPTABLE_BELPARABIRIM == 'EUR' THEN
		  TPEUR = TPEUR + TMPTABLE_BELTOPLAM;
		ENDIF;
		
		IF TMPTABLE_BELPARABIRIM == 'USD' THEN
          TPUSD = TPUSD + TMPTABLE_BELTOPLAM;      
        ENDIF;

        IF TMPTABLE_BELPARABIRIM == 'TL' THEN
          TPTL = TPTL + TMPTABLE_BELTOPLAM;
        ENDIF;		
        
        IF TMPTABLE_BELPARABIRIM == 'GBP' THEN
          TPGBP = TPGBP + TMPTABLE_BELTOPLAM;
        ENDIF;        
        
        IF TMPTABLE_BELPARABIRIM != 'EUR'
            && TMPTABLE_BELPARABIRIM != 'USD'
            && TMPTABLE_BELPARABIRIM != 'TL' 
            && TMPTABLE_BELPARABIRIM != 'GBP' THEN
          TPUNKNOWN = TPUNKNOWN + TMPTABLE_BELTOPLAM;
        ENDIF;
        
	ENDLOOP;

	TABLO = TABLO + '<h3>BAST101 GELEN POSTALARDA, YENİDEKİ FATURALAR TABLODAKİ GİBİDİR,</h3>';
	TABLO = TABLO + '<h4> TOPLAM BELGE SAYISI = '+TMPTABLE_ROWCOUNT+'</h4><h4> BELGELERİN TOPLAMI (EUR) = '+ NUMPICTFORMAT(TPEUR,PICT)+'</h4><h4> BELGELERİN TOPLAMI (USD) = '+ NUMPICTFORMAT(TPUSD,PICT2)+'</h4><h4> BELGELERİN TOPLAMI (TL) = '+ NUMPICTFORMAT(TPTL,PICT3)+'</h4><h4> BELGELERİN TOPLAMI (GBP) = '+ NUMPICTFORMAT(TPGBP,PICT7)+'</h4><h4> BİLİNMEYEN PARA BİRİMLERİNİN TOPLAMI = '+ NUMPICTFORMAT(TPUNKNOWN,PICT9)+'</h4><h5>YENİDEKİ BELGELER</h5>';
	TABLO = TABLO + '<table border = "1" style="width:340%;">';
	TABLO = TABLO + '<tr style="font-size:12px;"><th>KAYIT TİPİ</th><th>BELGE TİPİ</th><th>BELGE NUMARASI</th><th>İSİM</th><th>BELGE TARİHİ</th><th>BELGE TOPLAMI</th><th>PARA BİRİMİ</th><th>OLUŞTURMA TARİHİ</th><th>OLUŞTURAN</th><th>OLUŞTURMA TARİHİNDEN İTİBAREN KAÇ GÜN GEÇTİ</th></tr>';

	LOOP AT TMPTABLE 
	BEGIN
		TABLO = TABLO +  '<tr><td>' + TMPTABLE_KAYITTIP + '</td><td>' + TMPTABLE_BELTIP + '</td><td>' + TMPTABLE_BELNUM + '</td><td>' + TMPTABLE_ISIM1 + '</td>';
		TABLO = TABLO +  '<td>' + TMPTABLE_BELTARIH + '</td><td>' + TMPTABLE_BELTOPLAM + '</td><td>' + TMPTABLE_BELPARABIRIM + '</td><td>' + TMPTABLE_OLUSTURMATARIH + '</td><td>' + TMPTABLE_OLUSTURAN + '</td><td  style="background-color:pink;">' + TMPTABLE_KACGUNGECTI + '</td></tr>';
	ENDLOOP;

ENDIF;

SELECT CASE DOCCHAR WHEN 3 THEN 'SATIŞ İADE' WHEN 0 THEN 'SATIŞ' WHEN 6 THEN 'ALIŞ ONAY' WHEN 4 THEN 'ALIŞ' ELSE '' END KAYITTIP, 
	REFDOCTYPE AS BELTIP, REFDOCNUM AS BELNUM, LEFT(NAME1,
	 12) AS ISIM1, CAST(DOCDATE AS DATE) AS BELTARIH, DOCGRANDTOTAL AS BELTOPLAM, DOCCURRENCY AS BELPARABIRIM,
	 CAST(CREATEDAT AS DATE) AS OLUSTURMATARIH, CREATEDBY AS OLUSTURAN, DATEDIFF(DAY, CREATEDAT,
	 SYS_CURRENTDATE) AS KACGUNGECTI
	FROM IASEDIEINVOMSGQ 
	WHERE CLIENT = '00' 
		AND COMPANY = '01' 
		AND POSTWAY = 0 
		AND ACCOUNTNAME = '01' 
		AND STATUS = 1 
		AND CREATEDAT <= SYS_CURRENTDATE
		AND (DOCCHAR = 4 
		OR DOCCHAR = 1 
		OR DOCCHAR = 2 
		OR DOCCHAR = 3 
		OR DOCCHAR = 10 
		OR DOCCHAR = 11) 
		AND DOCDATE <= SYS_CURRENTDATE 
		AND ISEARCHIVE = 0 
		AND EDELTYPE = 0
	INTO TMPTABLE2;


IF TMPTABLE2_ROWCOUNT > 0 THEN

	LOOP AT TMPTABLE2
	BEGIN
		TP2 = TP2 + TMPTABLE2_BELTOPLAM;
		
		IF TMPTABLE2_BELPARABIRIM == 'EUR' THEN
          TPEUR2 = TPEUR2 + TMPTABLE2_BELTOPLAM;
        ENDIF;
        
        IF TMPTABLE2_BELPARABIRIM == 'USD' THEN
          TPUSD2 = TPUSD2 + TMPTABLE2_BELTOPLAM;      
        ENDIF;

        IF TMPTABLE2_BELPARABIRIM == 'TL' THEN
          TPTL2 = TPTL2 + TMPTABLE2_BELTOPLAM;
        ENDIF;        
        
        IF TMPTABLE2_BELPARABIRIM == 'GBP' THEN
          TPGBP2 = TPGBP2 + TMPTABLE2_BELTOPLAM;
        ENDIF; 
        
        IF TMPTABLE2_BELPARABIRIM != 'EUR'
            && TMPTABLE2_BELPARABIRIM != 'USD'
            && TMPTABLE2_BELPARABIRIM != 'TL' 
            && TMPTABLE2_BELPARABIRIM != 'GBP' THEN
          TPUNKNOWN2 = TPUNKNOWN2 + TMPTABLE2_BELTOPLAM;
        ENDIF;
                
	ENDLOOP;

	TABLO = TABLO + '</table><table><br><h3>BAST101 GELEN POSTALARDA, HATALIDAKİ KAYITLAR AŞAĞIDAKİ TABLODAKİ GİBİDİR,</h3>';
	TABLO = TABLO + '<h4> TOPLAM BELGE SAYISI = '+TMPTABLE2_ROWCOUNT+'</h4><h4> BELGELERİN TOPLAMI (EUR) = '+ NUMPICTFORMAT(TPEUR2,PICT4)+'</h4><h4> BELGELERİN TOPLAMI (USD) = '+ NUMPICTFORMAT(TPUSD2,PICT5)+'</h4><h4> BELGELERİN TOPLAMI (TL) = '+ NUMPICTFORMAT(TPTL2,PICT6)+'</h4><h4> BELGELERİN TOPLAMI (GBP) = '+ NUMPICTFORMAT(TPGBP2,PICT8)+'</h4><h4> BİLİNMEYEN PARA BİRİMLERİNİN TOPLAMI = '+ NUMPICTFORMAT(TPUNKNOWN2,PICT10)+'</h4><h5>HATALIDAKİ BELGELER</h5>';
	TABLO = TABLO + '<table border = "1" style="width:340%;">';
	TABLO = TABLO + '<tr style="font-size:12px;"><th>KAYIT TİPİ</th><th>BELGE TİPİ</th><th>BELGE NUMARASI</th><th>İSİM</th><th>BELGE TARİHİ</th><th>BELGE TOPLAMI</th><th>PARA BİRİMİ</th><th>OLUŞTURMA TARİHİ</th><th>OLUŞTURAN</th><th>OLUŞTURMA TARİHİNDEN İTİBAREN KAÇ GÜN GEÇTİ</th></tr>';

	LOOP AT TMPTABLE2 
	BEGIN
		TABLO = TABLO +  '<tr><td>' + TMPTABLE2_KAYITTIP + '</td><td>' + TMPTABLE2_BELTIP + '</td><td>' + TMPTABLE2_BELNUM + '</td><td>' + TMPTABLE2_ISIM1 + '</td>';
		TABLO = TABLO +  '<td>' + TMPTABLE2_BELTARIH + '</td><td>' + TMPTABLE2_BELTOPLAM + '</td><td>' + TMPTABLE2_BELPARABIRIM + '</td><td>' + TMPTABLE2_OLUSTURMATARIH + '</td><td>' + TMPTABLE2_OLUSTURAN + '</td><td  style="background-color:pink;">' + TMPTABLE2_KACGUNGECTI + '</td></tr>';
	ENDLOOP;

ENDIF;

TABLO = TABLO + '</table></body></html>';
MAILTEXT = TABLO;

IF TMPTABLE_ROWCOUNT > 0 
		|| TMPTABLE2_ROWCOUNT > 0 THEN
	SENDMAIL MESSAGE MAILTEXT TOADDRESS TOO CCADDRESS CCC TYPE 'HTML' SUBJECT SUBJ;

	IF ! SYS_STATUS THEN
		MESSAGE EFE I0 WITH 'MAİL GÖNDERİLDİ';
	ELSE
		MESSAGE EFE E0 WITH 'MAİL GÖNDERİLEMEDİ';
	ENDIF;

ENDIF;